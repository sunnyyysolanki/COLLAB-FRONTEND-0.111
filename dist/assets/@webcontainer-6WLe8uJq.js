var Q=Object.defineProperty;var Z=(t,e,r)=>e in t?Q(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var o=(t,e,r)=>Z(t,typeof e!="symbol"?e+"":e,r);const ee="https://stackblitz.com",te=new Error;te.stack="";const N={};let E=null;const re={get editorOrigin(){return E==null&&(E=new URL(globalThis.WEBCONTAINER_API_IFRAME_URL??ee).origin),E},set editorOrigin(t){E=new URL(t).origin},get url(){const t=new URL(this.editorOrigin);t.pathname="/headless";for(const e in N)t.searchParams.set(e,N[e]);return t.searchParams.set("version","1.5.1-internal.9"),t}};function ne(){let t,e;function r(){e=new Promise(n=>t=n)}return r(),{get promise(){return e},resolve(n){return t(n)},reset:r}}ne();var b;(function(t){t.UncaughtException="PREVIEW_UNCAUGHT_EXCEPTION",t.UnhandledRejection="PREVIEW_UNHANDLED_REJECTION",t.ConsoleError="PREVIEW_CONSOLE_ERROR"})(b||(b={}));var se=Object.defineProperty,ie=(t,e)=>{for(var r in e)se(t,r,{get:e[r],enumerable:!0})},h={};ie(h,{createEndpoint:()=>W,expose:()=>F,proxy:()=>Y,proxyMarker:()=>U,releaseProxy:()=>D,transfer:()=>B,transferHandlers:()=>M,windowEndpoint:()=>ue,wrap:()=>H});var U=Symbol("Comlink.proxy"),W=Symbol("Comlink.endpoint"),D=Symbol("Comlink.releaseProxy"),O=Symbol("Comlink.thrown"),z=t=>typeof t=="object"&&t!==null||typeof t=="function",ae={canHandle:t=>z(t)&&t[U],serialize(t){const{port1:e,port2:r}=new MessageChannel;return F(t,e),[r,[r]]},deserialize(t){return t.start(),H(t)}},oe={canHandle:t=>z(t)&&O in t,serialize({value:t}){let e;return t instanceof Error?e={isError:!0,value:{message:t.message,name:t.name,stack:t.stack}}:e={isError:!1,value:t},[e,[]]},deserialize(t){throw t.isError?Object.assign(new Error(t.value.message),t.value):t.value}},M=new Map([["proxy",ae],["throw",oe]]);function F(t,e=self){e.addEventListener("message",function r(n){if(!n||!n.data)return;const{id:s,type:i,path:a}=Object.assign({path:[]},n.data),c=(n.data.argumentList||[]).map(_);let l;try{const u=a.slice(0,-1).reduce((f,m)=>f[m],t),d=a.reduce((f,m)=>f[m],t);switch(i){case 0:l=d;break;case 1:u[a.slice(-1)[0]]=_(n.data.value),l=!0;break;case 2:l=d.apply(u,c);break;case 3:{const f=new d(...c);l=Y(f)}break;case 4:{const{port1:f,port2:m}=new MessageChannel;F(t,m),l=B(f,[f])}break;case 5:l=void 0;break}}catch(u){l={value:u,[O]:0}}Promise.resolve(l).catch(u=>({value:u,[O]:0})).then(u=>{const[d,f]=T(u);e.postMessage(Object.assign(Object.assign({},d),{id:s}),f),i===5&&(e.removeEventListener("message",r),V(e))})}),e.start&&e.start()}function ce(t){return t.constructor.name==="MessagePort"}function V(t){ce(t)&&t.close()}function H(t,e){return L(t,[],e)}function P(t){if(t)throw new Error("Proxy has been released and is not useable")}function L(t,e=[],r=function(){}){let n=!1;const s=new Proxy(r,{get(i,a){if(P(n),a===D)return()=>p(t,{type:5,path:e.map(c=>c.toString())}).then(()=>{V(t),n=!0});if(a==="then"){if(e.length===0)return{then:()=>s};const c=p(t,{type:0,path:e.map(l=>l.toString())}).then(_);return c.then.bind(c)}return L(t,[...e,a])},set(i,a,c){P(n);const[l,u]=T(c);return p(t,{type:1,path:[...e,a].map(d=>d.toString()),value:l},u).then(_)},apply(i,a,c){P(n);const l=e[e.length-1];if(l===W)return p(t,{type:4}).then(_);if(l==="bind")return L(t,e.slice(0,-1));const[u,d]=j(c);return p(t,{type:2,path:e.map(f=>f.toString()),argumentList:u},d).then(_)},construct(i,a){P(n);const[c,l]=j(a);return p(t,{type:3,path:e.map(u=>u.toString()),argumentList:c},l).then(_)}});return s}function le(t){return Array.prototype.concat.apply([],t)}function j(t){const e=t.map(T);return[e.map(r=>r[0]),le(e.map(r=>r[1]))]}var G=new WeakMap;function B(t,e){return G.set(t,e),t}function Y(t){return Object.assign(t,{[U]:!0})}function ue(t,e=self,r="*"){return{postMessage:(n,s)=>t.postMessage(n,r,s),addEventListener:e.addEventListener.bind(e),removeEventListener:e.removeEventListener.bind(e)}}function T(t){for(const[e,r]of M)if(r.canHandle(t)){const[n,s]=r.serialize(t);return[{type:3,name:e,value:n},s]}return[{type:0,value:t},G.get(t)||[]]}function _(t){switch(t.type){case 3:return M.get(t.name).deserialize(t.value);case 0:return t.value}}function p(t,e,r){return new Promise(n=>{const s=fe();t.addEventListener("message",function i(a){!a.data||!a.data.id||a.data.id!==s||(t.removeEventListener("message",i),n(a.data))}),t.start&&t.start(),t.postMessage(Object.assign({id:s},e),r)})}function fe(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}const de=[b.ConsoleError,b.UncaughtException,b.UnhandledRejection];function he(t){return!(t==null||typeof t!="object"||!("type"in t)||!de.includes(t.type))}function g(t){const e=Object.create(null);return t?Object.assign(e,t):e}function q(t){const e={d:{}};for(const r of Object.keys(t)){const n=t[r];if("file"in n){if("symlink"in n.file){e.d[r]={f:{l:n.file.symlink}};continue}const i=n.file.contents,a=typeof i=="string"?i:we(i),c=typeof i=="string"?{}:{b:!0};e.d[r]={f:{c:a,...c}};continue}const s=q(n.directory);e.d[r]=s}return e}function J(t){const e=g();if("f"in t)throw new Error("It is not possible to export a single file in the JSON format.");if("d"in t)for(const r of Object.keys(t.d)){const n=t.d[r];"d"in n?e[r]=g({directory:J(n)}):"f"in n&&("c"in n.f?e[r]=g({file:g({contents:n.f.c})}):"l"in n.f&&(e[r]=g({file:g({symlink:n.f.l})})))}return e}function we(t){let e="";for(const r of t)e+=String.fromCharCode(r);return e}let S=null,v=null,C={};const X=new TextDecoder,me=new TextEncoder,y=class y{constructor(e,r,n,s){o(this,"_instance");o(this,"_runtimeInfo");o(this,"fs");o(this,"internal");o(this,"_tornDown",!1);o(this,"_unsubscribeFromTokenChangedListener",()=>{});this._instance=e,this._runtimeInfo=s,this.fs=new Pe(r);const i=new Se(n);this.internal=new _e(i,e)}async spawn(e,r,n){let s=[];Array.isArray(r)?s=r:n=r;let i,a=new ReadableStream;if((n==null?void 0:n.output)!==!1){const w=I();i=w.push,a=w.stream}let c,l,u,d;if(l=new ReadableStream,d=new ReadableStream,n!=null&&n.stdout){const w=I();c=w.push,l=w.stream}if(n!=null&&n.stderr){const w=I();u=w.push,d=w.stream}const f=x(k(i)),m=x(k(c)),$=x(k(u)),K=await this._instance.run({command:e,args:s,cwd:n==null?void 0:n.cwd,env:n==null?void 0:n.env,terminal:n==null?void 0:n.terminal},m,$,f);return new Ee(K,a,l,d)}async export(e,r){const n={format:(r==null?void 0:r.format)??"json",includes:r==null?void 0:r.includes,excludes:r==null?void 0:r.excludes,external:!0},s=await this._instance.serialize(e,n);if(n.format==="json"){const i=JSON.parse(X.decode(s));return J(i)}return s}on(e,r){if(e==="preview-message"){const i=r;r=a=>{he(a)&&i(a)}}const{listener:n,subscribe:s}=R(r);return s(this._instance.on(e,h.proxy(n)))}mount(e,r){const n=e instanceof Uint8Array?e:e instanceof ArrayBuffer?new Uint8Array(e):me.encode(JSON.stringify(q(e)));return this._instance.loadFiles(h.transfer(n,[n.buffer]),{mountPoints:r==null?void 0:r.mountPoint})}setPreviewScript(e,r){return this._instance.setPreviewScript(e,r)}get path(){return this._runtimeInfo.path}get workdir(){return this._runtimeInfo.cwd}teardown(){if(this._tornDown)throw new Error("WebContainer already torn down");this._tornDown=!0,this._unsubscribeFromTokenChangedListener(),this.fs._teardown(),this._instance.teardown(),this._instance[h.releaseProxy](),y._instance===this&&(y._instance=null)}static async boot(e={}){const{workdirName:r}=e;if(window.crossOriginIsolated&&e.coep==="none"&&console.warn(`A Cross-Origin-Embedder-Policy header is required in cross origin isolated environments.
Set the 'coep' option to 'require-corp'.`),r!=null&&r.includes("/")||r===".."||r===".")throw new Error("workdirName should be a valid folder name");for(;S;)await S;if(y._instance)throw new Error("Only a single WebContainer instance can be booted");const n=ve(e);S=n.catch(()=>{});try{const s=await n;return y._instance=s,s}finally{S=null}}};o(y,"_instance",null);let A=y;class _e{constructor(e,r){o(this,"previewScript");o(this,"_instance");this.previewScript=e,this._instance=r}watchPaths(e,r){const{listener:n,subscribe:s}=R(r);return s(this._instance.watchPaths(e,h.proxy(n)))}getProcesses(){return this._instance.getProcesses()}onProcessesRemove(e){const{listener:r,subscribe:n}=R(e);return n(this._instance.onProcessesRemove(h.proxy(r)))}serialize(e,r){return this._instance.serialize(e,r)}setCORSProxy(e){return this._instance.setCORSProxy(e)}setCORSAuthToken(e){return this._instance.setCORSAuthToken(e)}}const ye=1,pe=2;class ge{constructor(e,r){o(this,"name");o(this,"_type");this.name=e,this._type=r}isFile(){return this._type===ye}isDirectory(){return this._type===pe}}class be{constructor(e,r,n,s){o(this,"_apiClient");o(this,"_path");o(this,"_options");o(this,"_listener");o(this,"_wrappedListener");o(this,"_watcher");o(this,"_closed",!1);this._apiClient=e,this._path=r,this._options=n,this._listener=s,this._apiClient._watchers.add(this),this._wrappedListener=(i,a)=>{this._listener&&!this._closed&&this._listener(i,a)},this._apiClient._fs.watch(this._path,this._options,x(this._wrappedListener)).then(i=>{this._watcher=i,this._closed&&this._teardown()}).catch(console.error)}close(){this._closed||(this._closed=!0,this._apiClient._watchers.delete(this),this._teardown())}_teardown(){var e;(e=this._watcher)==null||e.close().finally(()=>{var r;(r=this._watcher)==null||r[h.releaseProxy]()})}}class Ee{constructor(e,r,n,s){o(this,"output");o(this,"input");o(this,"exit");o(this,"_process");o(this,"stdout");o(this,"stderr");this.output=r,this._process=e,this.input=new WritableStream({write:i=>{var a;(a=this._getProcess())==null||a.write(i).catch(()=>{})}}),this.exit=this._onExit(),this.stdout=n,this.stderr=s}kill(){var e;(e=this._getProcess())==null||e.kill()}resize(e){var r;(r=this._getProcess())==null||r.resize(e)}async _onExit(){var e;try{return await this._process.onExit}finally{(e=this._process)==null||e[h.releaseProxy](),this._process=null}}_getProcess(){return this._process==null&&console.warn("This process already exited"),this._process}}class Pe{constructor(e){o(this,"_fs");o(this,"_watchers",new Set([]));this._fs=e}rm(...e){return this._fs.rm(...e)}async readFile(e,r){return await this._fs.readFile(e,r)}async rename(e,r){return await this._fs.rename(e,r)}async writeFile(e,r,n){if(r instanceof Uint8Array){const s=r.buffer.slice(r.byteOffset,r.byteOffset+r.byteLength);r=h.transfer(new Uint8Array(s),[s])}await this._fs.writeFile(e,r,n)}async readdir(e,r){const n=await this._fs.readdir(e,r);return Re(n)||Ce(n)?n:n.map(i=>new ge(i.name,i["Symbol(type)"]))}async mkdir(e,r){return await this._fs.mkdir(e,r)}watch(e,r,n){return typeof r=="function"&&(n=r,r=null),new be(this,e,r,n)}_teardown(){this._fs[h.releaseProxy]();for(const e of this._watchers)e.close()}}class Se{constructor(e){o(this,"_previewScript");o(this,"_listeners",new Map);o(this,"storage",{set:e=>{this._previewScript.storageSet(structuredClone(e))},get:()=>this._previewScript.storageGet(),on:(e,r)=>this._on("storage:change",r)});this._previewScript=e}broadcast(e){this._previewScript.broadcast(structuredClone(e))}on(e,r){return this._on(e,r)}_on(e,r){let n=this._listeners.get(e);if(!n){const s=new Set,{listener:i,subscribe:a}=R(c=>{s.forEach(l=>l(c))});n={localListeners:s,remoteUnsubscribe:a(this._previewScript.on(e,h.proxy(i)))}}return n.localListeners.add(r),()=>{const{localListeners:s,remoteUnsubscribe:i}=n;s.delete(r),s.size===0&&(i(),this._listeners.delete(e))}}}async function ve(t){const{serverPromise:e}=xe(t),n=await(await e).build({host:window.location.host,version:"1.5.1-internal.9",workdirName:t.workdirName,forwardPreviewErrors:t.forwardPreviewErrors}),[s,i,a]=await Promise.all([n.fs(),n.previewScript(),n.runtimeInfo()]);return new A(n,s,i,a)}function k(t){if(t!=null)return e=>{e instanceof Uint8Array?t(X.decode(e)):e==null&&t(null)}}function x(t){if(t!=null)return h.proxy(t)}function xe(t){if(v!=null)return t.coep!==C.coep&&(console.warn(`Attempting to boot WebContainer with 'coep: ${t.coep}'`),console.warn(`First boot had 'coep: ${C.coep}', new settings will not take effect!`)),{serverPromise:v};const e=document.createElement("iframe");e.style.display="none",e.setAttribute("allow","cross-origin-isolated");const r=re.url;t.coep&&r.searchParams.set("coep",t.coep),e.src=r.toString();const{origin:n}=r;return C={...t},v=new Promise(s=>{const i=a=>{if(a.origin!==n)return;const{data:c}=a;if(c.type==="init"){s(h.wrap(a.ports[0]));return}if(c.type==="warning"){console[c.level].call(console,c.message);return}};window.addEventListener("message",i)}),document.body.insertBefore(e,null),{serverPromise:v}}function Re(t){return typeof t[0]=="string"}function Ce(t){return t[0]instanceof Uint8Array}function I(){let t=null;return{stream:new ReadableStream({start(n){t=n}}),push:n=>{n!=null?t==null||t.enqueue(n):(t==null||t.close(),t=null)}}}function R(t){let e=!1,r=()=>{};return{subscribe(s){return s.then(i=>{r=i,e&&r()}),()=>{e=!0,r()}},listener:(...s)=>{e||t(...s)}}}export{A as W};
